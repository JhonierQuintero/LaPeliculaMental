<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mi Película Mental</title>
    <style>
        /* Importamos una fuente más imponente y moderna */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        /* ----------------- TEMAS Y VARIABLES MEJORADOS ----------------- */
        :root{
            --bg-gradient: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            --text-color: #1a202c;
            --primary-color: #4A90E2;
            --primary-gradient: linear-gradient(90deg, #4A90E2 0%, #58AFF6 100%);
            --secondary-color: #7B68EE;
            --secondary-gradient: linear-gradient(90deg, #7B68EE 0%, #9370DB 100%);
            --task-bg-color: rgba(255, 255, 255, 0.5);
            --card-bg-color: rgba(255, 255, 255, 0.6);
            --border-color: #d1d8e0;
            --input-bg-color: rgba(255, 255, 255, 0.8);
            --shadow-color: rgba(74, 144, 226, 0.15);
            --bubble-color: rgba(0, 0, 0, 0.08); /* Color de burbuja para temas claros */
            --backdrop-filter: blur(16px) saturate(180%);
            --font-family: 'Poppins', Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        [data-theme="dark"]{
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --text-color: #e2e8f0;
            --primary-color: #60a5fa;
            --primary-gradient: linear-gradient(90deg, #3b82f6 0%, #818cf8 100%);
            --secondary-color: #a78bfa;
            --secondary-gradient: linear-gradient(90deg, #a78bfa 0%, #c4b5fd 100%);
            --task-bg-color: rgba(30, 41, 59, 0.8);
            --card-bg-color: rgba(30, 41, 59, 0.6);
            --border-color: #334155;
            --input-bg-color: #1e293b;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --bubble-color: rgba(255, 255, 255, 0.1); /* Color de burbuja para tema oscuro */
        }
        [data-theme="warm"]{
            --bg-gradient: linear-gradient(135deg, #fffbeb 0%, #fde68a 100%);
            --text-color: #92400e;
            --primary-color: #f59e0b;
            --primary-gradient: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
            --secondary-color: #ea580c;
            --secondary-gradient: linear-gradient(90deg, #ea580c 0%, #f97316 100%);
            --task-bg-color: rgba(255, 251, 235, 0.7);
            --card-bg-color: rgba(255, 255, 255, 0.65);
            --border-color: #fcd34d;
            --input-bg-color: #fffbeb;
            --shadow-color: rgba(245, 158, 11, 0.2);
            --bubble-color: rgba(122, 43, 10, 0.1);
        }
        [data-theme="cold"]{
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            --text-color: #0c4a6e;
            --primary-color: #0ea5e9;
            --primary-gradient: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
            --secondary-color: #0891b2;
            --secondary-gradient: linear-gradient(90deg, #0891b2 0%, #06b6d4 100%);
            --task-bg-color: rgba(240, 249, 255, 0.8);
            --card-bg-color: rgba(255, 255, 255, 0.6);
            --border-color: #bae6fd;
            --input-bg-color: #f0f9ff;
            --shadow-color: rgba(14, 165, 233, 0.15);
            --bubble-color: rgba(12, 74, 110, 0.1);
        }

        /* ----------------- RESET Y BASE ----------------- */
        *{box-sizing:border-box;margin:0;padding:0}
        html{scroll-behavior:smooth}
        body{
            font-family: var(--font-family);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Contenedor para las burbujas */
        .bubbles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }
        .bubble {
            position: absolute;
            bottom: -150px;
            background-color: var(--bubble-color); /* Color adaptable! */
            border-radius: 50%;
            animation: floatUp 25s infinite ease-in;
            will-change: transform, opacity;
        }
        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-120vh);
                opacity: 0;
            }
        }


        .container{max-width:980px;margin:0 auto;padding:3rem 1.5rem; position: relative; z-index: 1;}
        .screen{display:none}
        .screen.active{display:block;animation:fadeIn .5s ease-in-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:none}}

        /* ----------------- TÍTULOS Y TEXTO ----------------- */
        h1,h2,h3{
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
            letter-spacing: -0.5px;
            text-align: center;
        }
        h1{font-size:clamp(2.2rem, 5vw, 3.5rem); text-shadow: 1px 1px 3px var(--shadow-color);}
        h2{font-size:clamp(1.8rem, 4vw, 2.5rem);}
        h3{font-size:clamp(1.2rem, 3vw, 1.5rem); font-weight: 700;}
        .muted{opacity:.8;font-size: 1rem; text-align: center; display: block;}
        
        /* Frase motivacional */
        .quote {
            font-style: italic;
            text-align: center;
            margin: 1.5rem auto;
            max-width: 600px;
            opacity: 0.9;
            font-size: 1.05rem;
        }
        .quote::before { content: '“'; }
        .quote::after { content: '”'; }


        /* ----------------- BOTONES Y TARJETAS ----------------- */
        button{
            background-image: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1rem 1.75rem;
            border-radius: 999px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px var(--shadow-color), 0 8px 10px -6px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        button:hover{transform:translateY(-3px); box-shadow: 0 12px 30px -5px var(--shadow-color), 0 10px 15px -6px var(--shadow-color);}
        button:active{transform:translateY(-1px)}
        button.secondary{background-image: var(--secondary-gradient)}
        button.danger{background-image:linear-gradient(90deg, #e53e3e, #f56565)}

        .card{
            background: var(--card-bg-color);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            backdrop-filter: var(--backdrop-filter);
            box-shadow: 0 20px 50px -10px var(--shadow-color);
            animation: floatCard 8s infinite alternate ease-in-out;
            will-change: transform;
        }
        @keyframes floatCard {
            from { transform: translateY(-5px); }
            to { transform: translateY(5px); }
        }


        /* ----------------- SECCIÓN DE DETALLES Y METAS MEJORADA ----------------- */
        .info-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: center;
            display: grid;
            gap: 2rem;
        }
        .info-list li strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        .info-list li span {
            font-size: 1.5rem;
            font-weight: 700;
            opacity: 1;
        }

        /* ----------------- FORMULARIOS ----------------- */
        label{display:block;margin-bottom:.5rem;font-weight:600; font-size: 1.05rem; text-align: left;}
        input[type="text"],input[type="number"],textarea,select,input[type="file"]{
            width:100%;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg-color);
            color: var(--text-color);
            font-size: 1rem;
            font-family: var(--font-family);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-color);
        }
        textarea{resize:vertical;min-height:100px;max-height:280px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
        .form-group{margin-bottom:1.5rem}

        /* ----------------- GALERÍA Y PREVIEWS ----------------- */
        .image-previews, #movie-image-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:1rem;margin-top:1rem; place-items: center;}
        .image-previews img, #movie-image-gallery img{width:100%;height:100px;object-fit:cover;border-radius:12px;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease; border: 2px solid transparent;}
        .image-previews img:hover, #movie-image-gallery img:hover{transform:scale(1.05); box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--primary-color);}

        /* ----------------- TAREAS Y PROGRESO (REDiseñado) ----------------- */
        #task-list{list-style:none;padding:0; display: flex; flex-direction: column; gap: 0.75rem;}
        #task-list li{
            display:flex;
            align-items:center;
            gap:1rem;
            padding: 1rem;
            border: none;
            background-color: var(--task-bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: opacity 0.3s ease;
        }
        #task-list li.completed{opacity: 0.6;}
        #task-list li.completed .task-text{text-decoration:line-through}
        .task-text{flex:1; text-align: left;}
        .delete-task{background:none;border:none;color:#ef4444;font-size:1.3rem;cursor:pointer;padding:.2rem; transition: transform 0.2s ease;}
        .delete-task:hover { transform: scale(1.2); }
        #new-task-form{display:flex;gap:.8rem;margin-top:1.5rem}
        #new-task-input{flex:1}

        #progress-bar-container{background: var(--input-bg-color);height:16px;border-radius:999px;overflow:hidden;margin-top:1rem; border: 1px solid var(--border-color);}
        #progress-bar{height:100%;width:0;transition:width .5s cubic-bezier(0.25, 1, 0.5, 1);background-image:var(--primary-gradient)}

        /* ----------------- HEADER PELÍCULA ----------------- */
        .movie-header{text-align:center;margin-bottom:2rem}
        #movie-title{font-weight:800}
        #movie-description{margin-top:.8rem;font-size:1.1rem;max-width:820px;margin-left:auto;margin-right:auto}

        /* ----------------- CONTROLES Y THEME ----------------- */
        .theme-switcher{position:fixed;top:1.5rem;right:1.5rem;z-index:1000}
        .theme-switcher select {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg-color);
            box-shadow: 0 5px 15px var(--shadow-color);
            cursor: pointer;
        }
        .controls-panel{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-top:2rem}

        /* ----------------- MODAL IMAGEN ----------------- */
        .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:120; backdrop-filter: blur(5px);}
        .modal.active{display:flex; animation: fadeIn 0.3s ease;}
        .modal img{max-width:90vw;max-height:90vh;border-radius:16px; box-shadow: 0 0 50px rgba(0,0,0,0.5);}
        
        /* ----------------- PIE DE PÁGINA ----------------- */
        .footer-quote {
            text-align: center;
            padding: 3rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        /* ----------------- PRINT (EXPORTAR) ----------------- */
        @media print{
            .bubbles-container { display: none; }
            body{background:white;color:black; font-family: 'Times New Roman', serif;}
            .no-print{display:none !important}
            .card{box-shadow:none;border:1px solid #ccc;background:transparent; padding: 1.5rem; animation: none;}
            .container { padding: 0; }
        }

        /* ----------------- RESPONSIVE ----------------- */
        @media(max-width:768px){
            .form-row{grid-template-columns:1fr}
            .container{padding:2rem 1rem}
            .card{padding: 1.5rem; animation: none;}
            h1 { font-size: 2rem; }
            h2 { font-size: 1.6rem; }
            button { padding: 0.8rem 1.2rem; font-size: 0.9rem;}
            .theme-switcher { top: 1rem; right: 1rem; }
            .info-list li span { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div class="bubbles-container"></div>
    <div class="theme-switcher no-print" title="Seleccionar tema">
        <select id="theme-select" aria-label="Seleccionar tema">
            <option value="light">Claro ☀</option>
            <option value="dark">Oscuro 🌙</option>
            <option value="warm">Cálido 🔥</option>
            <option value="cold">Frío ❄</option>
        </select>
    </div>

    <main class="container" id="app">
        <!-- PANTALLA DE BIENVENIDA -->
        <section id="welcome-screen" class="screen active">
            <div class="card" style="text-align:center">
                <h1>¿Estás listo para crear tu película mental?</h1>
                <p class="muted">Haz clic en comenzar y responde unas preguntas para construir tu película mental personalizada.</p>
                <p class="quote">El futuro pertenece a quienes creen en la belleza de sus sueños.</p>
                <div style="margin-top:2rem">
                    <button id="start-btn" class="no-print">Comenzar</button>
                </div>
            </div>
        </section>

        <!-- FORMULARIO -->
        <section id="form-screen" class="screen">
            <form id="movie-form" class="card" novalidate>
                <h2>Crea tu Película Mental</h2>
                <p class="quote">Cada gran logro comienza con la decisión de intentarlo.</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="user-name">Tu Nombre <span aria-hidden="true">*</span></label>
                        <input id="user-name" type="text" required maxlength="80" />
                    </div>
                    <div class="form-group">
                        <label for="user-age">Tu Edad</label>
                        <input id="user-age" type="number" min="1" max="120" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="form-title">Título de tu Película <span aria-hidden="true">*</span></label>
                    <input id="form-title" type="text" required maxlength="120" />
                </div>

                <div class="form-group">
                    <label for="form-description">¿Cómo es tu película mental?</label>
                    <textarea id="form-description" maxlength="1000" placeholder="Describe cómo te imaginas tu película mental..."></textarea>
                </div>

                <div class="card" style="padding:1.5rem;margin-top:1rem; animation: none;">
                    <h3>Metas a Futuro</h3>
                    <div class="form-group">
                        <label for="goal-2y">Metas a 2 años</label>
                        <textarea id="goal-2y" rows="2" maxlength="600"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="goal-5y">Metas a 5 años</label>
                        <textarea id="goal-5y" rows="2" maxlength="600"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="goal-10y">Metas a 10 años</label>
                        <textarea id="goal-10y" rows="2" maxlength="600"></textarea>
                    </div>
                </div>

                <div class="card" style="padding:1.5rem;margin-top:1rem; animation: none;">
                    <h3>Recursos Multimedia</h3>
                    <div class="form-group">
                        <label for="audio-upload">Música de Fondo (máx 5 MB)</label>
                        <input id="audio-upload" type="file" accept="audio/*" />
                        <p class="muted" style="margin-top:.35rem; text-align: left;">La música se guardará en el navegador y reproducirá en la vista de la película.</p>
                    </div>
                    <div class="form-group">
                        <label for="image-upload">Imágenes (máx 5 MB cada una)</label>
                        <input id="image-upload" type="file" accept="image/*" multiple />
                        <div class="image-previews" id="image-preview-container" aria-live="polite"></div>
                    </div>
                </div>

                <div style="display:flex;gap:.8rem;flex-wrap:wrap;margin-top:1rem; justify-content: center;">
                    <button type="submit" id="create-btn" class="no-print">Crear mi Película Mental</button>
                    <button type="button" id="download-json-btn" class="secondary no-print">Descargar JSON</button>
                </div>
            </form>
        </section>

        <!-- VISTA PELÍCULA -->
        <section id="movie-screen" class="screen">
            <div class="movie-header card">
                <h1 id="movie-title">Título</h1>
                <p id="movie-description" class="muted">Descripción</p>
                <div id="movie-audio-player" style="margin-top:1rem"></div>
            </div>
            
            <p class="quote">Este es el comienzo de todo lo que siempre has querido.</p>

            <div class="card">
                <h3>Detalles</h3>
                <ul class="info-list">
                    <li><strong>Creador:</strong> <span id="movie-user-name" class="muted"></span></li>
                    <li><strong>Edad:</strong> <span id="movie-user-age" class="muted"></span></li>
                </ul>
            </div>

            <div class="card">
                <h3>Metas a Futuro</h3>
                <ul class="info-list">
                    <li><strong>A 2 años:</strong> <span id="movie-goal-2y" class="muted"></span></li>
                    <li><strong>A 5 años:</strong> <span id="movie-goal-5y" class="muted"></span></li>
                    <li><strong>A 10 años:</strong> <span id="movie-goal-10y" class="muted"></span></li>
                </ul>
            </div>

            <div class="card" id="gallery-panel">
                <h3>Galería</h3>
                <div id="movie-image-gallery"></div>
            </div>

            <div class="card" id="task-panel">
                <h3>Tareas para alcanzar tu meta</h3>
                <ul id="task-list"></ul>
                <form id="new-task-form" class="no-print" aria-label="Añadir tarea">
                    <input id="new-task-input" type="text" placeholder="Añadir nueva tarea..." maxlength="180" required />
                    <button type="submit">Añadir</button>
                </form>

                <div style="margin-top:1.5rem">
                    <p id="progress-text" class="muted"></p>
                    <div id="progress-bar-container"><div id="progress-bar"></div></div>
                </div>
            </div>

            <div class="controls-panel no-print">
                <button id="export-pdf-btn" class="secondary">Exportar a PDF / Imprimir</button>
                <button id="download-all-json-btn">Descargar todo (JSON)</button>
                <button id="delete-movie-btn" class="danger">Eliminar película mental</button>
            </div>
        </section>
    </main>

    <footer class="footer-quote no-print">
        ¡Sigue adelante! Cada paso, por pequeño que sea, te acerca a la obra maestra que es tu futuro.
    </footer>

    <!-- MODAL PARA IMAGEN -->
    <div id="image-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <img id="modal-img" alt="Imagen ampliada" />
    </div>

    <!-- SCRIPT PARA LAS BURBUJAS -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const bubblesContainer = document.querySelector('.bubbles-container');
            const numberOfBubbles = 25; // Aumentamos un poco para más efecto

            for (let i = 0; i < numberOfBubbles; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                const size = Math.random() * 80 + 20; // Tamaño entre 20 y 100px
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;
                const duration = Math.random() * 15 + 10; // Duración entre 10 y 25s
                bubble.style.animationDuration = `${duration}s`;
                const delay = Math.random() * 7; // Retraso para que no empiecen todas a la vez
                bubble.style.animationDelay = `${delay}s`;
                bubblesContainer.appendChild(bubble);
            }
        });

    (function () {
        // ---------- CONSTANTES ----------
        const LOCAL_STORAGE_KEY = 'mentalMovieData_v1';
        const THEME_STORAGE_KEY = 'mentalMovieTheme_v1';
        const MAX_FILE_MB = 5;
        const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

        // ---------- ELEMENTOS ----------
        const welcomeScreen = document.getElementById('welcome-screen');
        const formScreen = document.getElementById('form-screen');
        const movieScreen = document.getElementById('movie-screen');
        const startBtn = document.getElementById('start-btn');
        const movieForm = document.getElementById('movie-form');
        const audioUpload = document.getElementById('audio-upload');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');

        const movieTitle = document.getElementById('movie-title');
        const movieDescription = document.getElementById('movie-description');
        const movieUserName = document.getElementById('movie-user-name');
        const movieUserAge = document.getElementById('movie-user-age');
        const movieGoal2 = document.getElementById('movie-goal-2y');
        const movieGoal5 = document.getElementById('movie-goal-5y');
        const movieGoal10 = document.getElementById('movie-goal-10y');
        const movieImageGallery = document.getElementById('movie-image-gallery');
        const movieAudioPlayer = document.getElementById('movie-audio-player');

        const newTaskForm = document.getElementById('new-task-form');
        const newTaskInput = document.getElementById('new-task-input');
        const taskListEl = document.getElementById('task-list');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const deleteMovieBtn = document.getElementById('delete-movie-btn');
        const downloadAllJsonBtn = document.getElementById('download-all-json-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');

        const themeSelect = document.getElementById('theme-select');

        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');

        // ---------- ESTADO ---------- 
        // estructura de datos guardada en localStorage
        // {
        //  userName, userAge, title, description,
        //  goals: { '2y','5y','10y' },
        //  audioDataUrl: string|null,
        //  imageDataUrls: [string,...],
        //  tasks: [{text,completed}, ...]
        // }
        let currentData = null;
        let currentAudio = null; // objeto Audio para control

        // ---------- UTILIDADES ----------
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = () => reject(new Error('Error leyendo el archivo'));
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                //console.error('Error guardando en localStorage', e);
                //alert('No se pudo guardar. El almacenamiento local puede estar lleno.');
            }
        }
        function loadFromLocalStorage() {
            try {
                const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                console.error('Error leyendo localStorage', e);
                return null;
            }
        }
        function removeFromLocalStorage() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
        }

        // ---------- NAVEGACIÓN ENTRE PANTALLAS ----------
        function showScreen(screenEl) {
            [welcomeScreen, formScreen, movieScreen].forEach(s => s.classList.remove('active'));
            screenEl.classList.add('active');
            // Scroll to top for better UX
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ---------- RENDERIZADO DE LA "PELÍCULA" ----------
        function renderMovie(data) {
            if (!data) return;
            movieTitle.textContent = data.title || 'Sin título';
            movieDescription.textContent = data.description || '';
            movieUserName.textContent = data.userName || 'Anónimo';
            movieUserAge.textContent = data.userAge || '—';
            movieGoal2.textContent = data.goals?.['2y'] || 'Sin definir';
            movieGoal5.textContent = data.goals?.['5y'] || 'Sin definir';
            movieGoal10.textContent = data.goals?.['10y'] || 'Sin definir';

            // audio
            movieAudioPlayer.innerHTML = '';
            if (data.audioDataUrl) {
                try {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio.src = '';
                        currentAudio = null;
                    }
                    const audio = document.createElement('audio');
                    audio.src = data.audioDataUrl;
                    audio.controls = true;
                    audio.loop = true;
                    audio.setAttribute('aria-label', 'Reproductor de música de fondo');
                    movieAudioPlayer.appendChild(audio);
                    currentAudio = audio;
                    // Intentar reproducir (puede bloquearse sin gesto del usuario)
                    audio.play().catch(() => {
                        /* autoplay bloqueado, el usuario puede pulsar play */
                    });
                } catch (e) {
                    console.warn('No se pudo preparar audio', e);
                }
            }

            // galería
            movieImageGallery.innerHTML = '';
            if (data.imageDataUrls && data.imageDataUrls.length) {
                data.imageDataUrls.forEach((url, i) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Imagen ${i + 1}`;
                    img.tabIndex = 0;
                    img.addEventListener('click', () => openImageModal(url));
                    img.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') openImageModal(url); });
                    movieImageGallery.appendChild(img);
                });
                document.getElementById('gallery-panel').style.display = 'block';
            } else {
                movieImageGallery.innerHTML = '<p class="muted">No hay imágenes añadidas.</p>';
            }

            // tareas
            renderTasks(data.tasks || []);

            // mostrar pantalla película
            showScreen(movieScreen);
        }

        // ---------- TAREAS: RENDER Y PROGRESO ----------
        function renderTasks(tasks) {
            taskListEl.innerHTML = '';
            tasks = tasks || [];
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = task.completed ? 'completed' : '';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !!task.completed;
                checkbox.setAttribute('aria-label', `Marcar tarea ${task.text}`);
                checkbox.dataset.index = index;

                const span = document.createElement('span');
                span.className = 'task-text';
                span.textContent = task.text;

                const btnDel = document.createElement('button');
                btnDel.className = 'delete-task';
                btnDel.innerHTML = '&times;';
                btnDel.title = 'Eliminar tarea';
                btnDel.dataset.index = index;

                // events
                checkbox.addEventListener('change', onTaskToggle);
                btnDel.addEventListener('click', onTaskDelete);

                li.appendChild(checkbox);
                li.appendChild(span);
                li.appendChild(btnDel);
                taskListEl.appendChild(li);
            });
            updateProgress(tasks);
        }

        function updateProgress(tasks) {
            tasks = tasks || [];
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percentage = total === 0 ? 0 : Math.round((completed / total) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${completed} de ${total} tareas completadas (${percentage}%)`;
        }

        // ---------- MANEJO DE EVENTOS TAREAS ----------
        function onTaskToggle(e) {
            const idx = Number(e.target.dataset.index);
            if (!currentData) return;
            if (!Array.isArray(currentData.tasks)) currentData.tasks = [];
            if (currentData.tasks[idx]) {
                currentData.tasks[idx].completed = e.target.checked;
                saveToLocalStorage(currentData);
                renderTasks(currentData.tasks);
            }
        }
        function onTaskDelete(e) {
            const idx = Number(e.target.dataset.index);
            if (!currentData) return;
            if (!Array.isArray(currentData.tasks)) currentData.tasks = [];
            currentData.tasks.splice(idx, 1);
            saveToLocalStorage(currentData);
            renderTasks(currentData.tasks);
        }

        // ---------- MANEJO DE FORMULARIO Y ARCHIVOS ----------
        startBtn.addEventListener('click', () => {
            showScreen(formScreen);
        });

        // audio input
        audioUpload.addEventListener('change', async (ev) => {
            const file = ev.target.files[0];
            if (!file) return;
            if (file.size > MAX_FILE_BYTES) {
                alert(`El archivo supera el límite de ${MAX_FILE_MB} MB. Elige otro archivo.`);
                audioUpload.value = '';
                return;
            }
            try {
                const dataUrl = await fileToDataUrl(file);
                // keep temp in currentData until submit
                if (!currentData) currentData = {};
                currentData.audioDataUrl = dataUrl;
            } catch (e) {
                console.error(e);
                alert('Error al procesar el audio.');
            }
        });

        // images input
        imageUpload.addEventListener('change', async (ev) => {
            const files = Array.from(ev.target.files || []);
            if (!files.length) return;
            // check sizes
            for (const f of files) {
                if (f.size > MAX_FILE_BYTES) {
                    alert(`El archivo "${f.name}" supera ${MAX_FILE_MB} MB. No se añadirá.`);
                    return;
                }
            }
            // read all
            imagePreviewContainer.innerHTML = 'Cargando...';
            try {
                const dataUrls = await Promise.all(files.map(fileToDataUrl));
                // store temporarily in currentData
                if (!currentData) currentData = {};
                currentData.imageDataUrls = (currentData.imageDataUrls || []).concat(dataUrls);
                // show previews
                renderImagePreviews(currentData.imageDataUrls);
            } catch (e) {
                console.error(e);
                alert('Error al procesar las imágenes.');
            } finally {
                // clear file input to allow re-upload same files if needed
                imageUpload.value = '';
            }
        });

        function renderImagePreviews(urls) {
            imagePreviewContainer.innerHTML = '';
            urls = urls || [];
            urls.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'Previsualización';
                img.addEventListener('click', () => openImageModal(url));
                imagePreviewContainer.appendChild(img);
            });
        }

        // submit crear película
        movieForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            // validación mínima
            const name = document.getElementById('user-name').value.trim();
            const title = document.getElementById('form-title').value.trim();
            if (!name || !title) {
                alert('Por favor, completa los campos ¡Nombre y Título son obligatorios!');
                return;
            }

            // construir objeto
            const data = {
                userName: name,
                userAge: document.getElementById('user-age').value || '',
                title: title,
                description: document.getElementById('form-description').value || '',
                goals: {
                    '2y': document.getElementById('goal-2y').value || '',
                    '5y': document.getElementById('goal-5y').value || '',
                    '10y': document.getElementById('goal-10y').value || ''
                },
                audioDataUrl: (currentData && currentData.audioDataUrl) ? currentData.audioDataUrl : null,
                imageDataUrls: (currentData && currentData.imageDataUrls) ? currentData.imageDataUrls : [],
                tasks: (currentData && currentData.tasks) ? currentData.tasks : []
            };

            currentData = data;
            saveToLocalStorage(currentData);
            renderMovie(currentData);
        });

        // añadir tarea
        newTaskForm.addEventListener('submit', (ev) => {
            ev.preventDefault();
            const text = newTaskInput.value.trim();
            if (!text) return;
            if (!currentData) currentData = { tasks: [] };
            currentData.tasks = currentData.tasks || [];
            currentData.tasks.push({ text, completed: false });
            saveToLocalStorage(currentData);
            renderTasks(currentData.tasks);
            newTaskInput.value = '';
        });

        // abrir modal imagen
        function openImageModal(url) {
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            modalImg.src = url;
        }
        modal.addEventListener('click', () => {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            modalImg.src = '';
        });

        // exportar print/pdf
        exportPdfBtn.addEventListener('click', () => {
            // usar window.print() y estilos @media print
            window.print();
        });

        // eliminar película
        deleteMovieBtn.addEventListener('click', () => {
            if (!confirm('¿Seguro que deseas eliminar tu película mental? Esta acción no se puede deshacer.')) return;
            removeFromLocalStorage();
            currentData = null;
            // limpiar UI
            imagePreviewContainer.innerHTML = '';
            movieImageGallery.innerHTML = '';
            movieAudioPlayer.innerHTML = '';
            taskListEl.innerHTML = '';
            progressBar.style.width = '0%';
            progressText.textContent = '';
            // volver al inicio
            showScreen(welcomeScreen);
        });

        // descargar JSON (backup)
        downloadAllJsonBtn.addEventListener('click', () => {
            const data = loadFromLocalStorage();
            if (!data) { alert('No hay datos para descargar.'); return; }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(data.title || 'pelicula-mental').replace(/\s+/g,'_')}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        downloadJsonBtn.addEventListener('click', () => {
            const data = {
                userName: document.getElementById('user-name').value || '',
                userAge: document.getElementById('user-age').value || '',
                title: document.getElementById('form-title').value || '',
                description: document.getElementById('form-description').value || '',
                goals: {
                    '2y': document.getElementById('goal-2y').value || '',
                    '5y': document.getElementById('goal-5y').value || '',
                    '10y': document.getElementById('goal-10y').value || ''
                },
                audioDataUrl: (currentData && currentData.audioDataUrl) ? currentData.audioDataUrl : null,
                imageDataUrls: (currentData && currentData.imageDataUrls) ? currentData.imageDataUrls : [],
                tasks: (currentData && currentData.tasks) ? currentData.tasks : []
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = ((data.title || 'pelicula-mental-form').replace(/\s+/g,'_')) + '.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        // tema
        themeSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'light') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', val);
            }
            localStorage.setItem(THEME_STORAGE_KEY, val);
        });
        function applySavedTheme() {
            const saved = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
            if (saved === 'light') document.documentElement.removeAttribute('data-theme');
            else document.documentElement.setAttribute('data-theme', saved);
            themeSelect.value = saved;
        }

        // INICIALIZAR APP: cargar datos guardados si existen
        function initializeApp() {
            applySavedTheme();
            const saved = loadFromLocalStorage();
            if (saved) {
                currentData = saved;
                // populamos el formulario por conveniencia (opcional)
                document.getElementById('user-name').value = saved.userName || '';
                document.getElementById('user-age').value = saved.userAge || '';
                document.getElementById('form-title').value = saved.title || '';
                document.getElementById('form-description').value = saved.description || '';
                document.getElementById('goal-2y').value = saved.goals?.['2y'] || '';
                document.getElementById('goal-5y').value = saved.goals?.['5y'] || '';
                document.getElementById('goal-10y').value = saved.goals?.['10y'] || '';
                // previews e imágenes
                if (saved.imageDataUrls && saved.imageDataUrls.length) {
                    renderImagePreviews(saved.imageDataUrls);
                }
                // tareas
                if (saved.tasks && saved.tasks.length) {
                    renderTasks(saved.tasks);
                }
                // si había creado previamente, abrir directamente la vista película
                renderMovie(saved);
            } else {
                showScreen(welcomeScreen);
            }
        }

        // llamado inicial
        initializeApp();

        // accesibilidad: ESC cierra modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    modal.setAttribute('aria-hidden', 'true');
                    modalImg.src = '';
                }
            }
        });

    })();
    </script>
</body>
</html>